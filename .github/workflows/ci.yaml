name: ci
on:
  push:
    branches:
      - '**'
    tags-ignore:
      - '*'
  pull_request:
env:
  GO: 1.19.x
jobs:
  test-os:
    strategy:
      fail-fast: false
      matrix:
        platform: [macos-latest, windows-latest]
    runs-on: ${{ matrix.platform }}
    steps:
    - uses: actions/setup-go@v3
      with:
        go-version: ${{ env.GO }}
    - uses: actions/checkout@v3
    - run: make test
  test-ubuntu:
    runs-on: ubuntu-latest
    steps:
    - uses: actions/setup-go@v3
      with:
        go-version: ${{ env.GO }}
    - uses: actions/checkout@v3
    - run: make lcov
    - name: Send coverage
      uses: coverallsapp/github-action@1.1.3
      with:
        github-token: ${{ secrets.GITHUB_TOKEN }}
        path-to-lcov: coverage.lcov
  test-docker:
    runs-on: ubuntu-latest
    steps:
    - id: buildx
      uses: docker/setup-buildx-action@v2
    - uses: actions/checkout@v3
    - run: make docker-test
  test-version:
    if: (github.event_name == 'pull_request') || (github.event_name == 'push' && github.ref == 'refs/heads/main')
    runs-on: ubuntu-latest
    steps:
    - uses: actions/setup-go@v3
      with:
        go-version: ${{ env.GO }}
    - uses: actions/checkout@v3
    - name: Release validation of the CHANGELOG.md
      id: clq-extract
      run: |
        make build
        release_version=$(dist/clq -changeMap .github/clq/changemap.json -release -query 'releases[0].version' CHANGELOG.md)
        echo "::set-output name=tag::v${release_version}"
    - uses: denisa/semantic-tag-helper@v1
      with:
        mode: test
        tag: ${{ steps.clq-extract.outputs.tag }}
  test:
    needs: [test-os, test-ubuntu, test-docker, test-version]
    runs-on: ubuntu-latest
    steps:
    - name: Release validation of the CHANGELOG.md
      run: |
        echo "All tests passed"
  release:
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'
    needs: test
    runs-on: ubuntu-latest
    environment:
      name: dockerhub
      url: https://hub.docker.com/repository/docker/denisa/clq
    steps:
    - uses: actions/setup-go@v3
      with:
        go-version: ${{ env.GO }}
    - uses: docker/setup-qemu-action@v2
    - uses: docker/setup-buildx-action@v2
      id: buildx
    - uses: docker/login-action@v2
      with:
        username: ${{ secrets.DOCKER_HUB_USERNAME }}
        password: ${{ secrets.DOCKER_HUB_ACCESS_TOKEN }}
    - uses: actions/checkout@v3
    - run: make build
    - name: Extract release information
      id: clq-extract
      run: |
        release_version=$(dist/clq -changeMap .github/clq/changemap.json -release -query 'releases[0].version' CHANGELOG.md)

        release_name=$(dist/clq -changeMap .github/clq/changemap.json -release -query 'releases[0].label' CHANGELOG.md)
        if [ -z "$release_name" ]; then
          release_name="Release $release_version"
        fi

        release_status=$(dist/clq -changeMap .github/clq/changemap.json -release -query 'releases[0].status' CHANGELOG.md)

        release_changes=$(dist/clq -changeMap .github/clq/changemap.json -release -output md -query 'releases[0].changes[]/' CHANGELOG.md)

        echo "::set-output name=changes::${release_changes//$'\n'/'%0A'}"
        echo "::set-output name=name::$release_name"
        echo "::set-output name=status::$release_status"
        echo "::set-output name=tag::v${release_version}"
        echo "::set-output name=version::$release_version"
    - run: |
        release_version=${{ steps.clq-extract.outputs.version }}
        VERSION=$release_version make clean assertVersionDefined build-all
        test "$(dist/clq-linux-amd64 -changeMap .github/clq/changemap.json -version)" = "clq $release_version"
        VERSION=$release_version make assertVersionDefined docker-test
    - uses: docker/build-push-action@v3
      with:
        builder: ${{ steps.buildx.outputs.name }}
        build-args: |
          DOCKER_TAG=${{ steps.clq-extract.outputs.version }}
        context: .
        file: build/docker/alpine/Dockerfile
        platforms: linux/amd64,linux/arm64
        push: true
        tags: |
          denisa/clq:${{ steps.clq-extract.outputs.version }}-alpine
    - uses: docker/build-push-action@v3
      with:
        builder: ${{ steps.buildx.outputs.name }}
        build-args: |
          DOCKER_TAG=${{ steps.clq-extract.outputs.version }}
        context: .
        file: build/docker/slim/Dockerfile
        platforms: linux/amd64,linux/arm64
        push: true
        tags: |
          denisa/clq:${{ steps.clq-extract.outputs.version }}
          denisa/clq:${{ steps.clq-extract.outputs.version }}-slim
          denisa/clq:latest
    - uses: denisa/semantic-tag-helper@v1
      with:
        mode: set
        tag: ${{ steps.clq-extract.outputs.tag }}
    - uses: ncipollo/release-action@v1.11.1
      id: create_release
      with:
        tag: ${{ steps.clq-extract.outputs.tag }}
        prerelease: ${{ steps.clq-extract.outputs.status == 'prereleased' }}
        name: ${{ steps.clq-extract.outputs.name }}
        body: ${{ steps.clq-extract.outputs.changes }}
        artifactContentType: application/octet-stream
        artifacts: "dist/*"
